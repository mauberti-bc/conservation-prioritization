autoscaling:
  enabled: false
  maxReplicas: 1
  minReplicas: 1

gitRepo: https://github.com/mauberti-bc/conservation-prioritization.git
gitRef: main
registry: image-registry.apps.gold.devops.gov.bc.ca/fa9440-tools

# Centralized common ports and URLs
ports:
  frontend: 7070
  api: 5200
  prefect_server_api: 4200
  prefect_worker_api: 8081

prefect-server:
  serviceAccount:
    create: false
    name: prefect-server
  ui:
    enabled: true
    podSecurityContext:
      runAsUser: 1003600000
      fsGroup: null
    containerSecurityContext:
      runAsUser: 1003600000
      runAsNonRoot: true
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities:
        drop:
          - ALL
    resources:
      requests:
        cpu: 50m
        memory: 256Mi
      limits:
        cpu: 100m
        memory: 256Mi
  server:
    podSecurityContext:
      runAsUser: 1003600000
      fsGroup: null
    containerSecurityContext:
      runAsUser: 1003600000
      runAsNonRoot: true
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities:
        drop:
          - ALL
    resources:
      requests:
        cpu: 50m
        memory: 256Mi
      limits:
        cpu: 100m
        memory: 256Mi
    env:
      - PREFECT_SERVER_API_HOST: "0.0.0.0"
      - PREFECT_UI_API_URL: http://localhost:4200/api

  ingress:
    enabled: true
    host:
      hostname: conservation-tool-prefect-server-fa9440-dev.apps.gold.devops.gov.bc.ca
      path: /
    className: "openshift-default"

services:
  frontend:
    replicas: 1

    image:
      stream: frontend
      tag: dev
      pullPolicy: "Always"

    service:
      type: ClusterIP
      port: {{ .Values.ports.frontend | default 7070 }}
      targetPort: {{ .Values.ports.frontend | default 7070 }}

    route:
      host: conservation123.nrs.gov.bc.ca

    # OpenShift security context - using your UID range
    securityContext:
      runAsUser: 1003600000
      fsGroup: 1003600000

    resources:
      requests:
        cpu: 50m
        memory: 256Mi
      limits:
        cpu: 100m
        memory: 256Mi

    # Health checks for Caddy
    livenessProbe:
      enabled: false
      path: "/health"  # Make sure your Caddyfile includes: respond /health 200
      initialDelaySeconds: 30
      periodSeconds: 10

    readinessProbe:
      enabled: false
      path: "/health"  # Make sure your Caddyfile includes: respond /health 200
      initialDelaySeconds: 5
      periodSeconds: 5

    extraVolumeMounts: []
    extraVolumes: []

  workflows:
    worker:
      replicas: 1
      pool: pool
      image:
        stream: prefect-worker
        tag: dev
        pullPolicy: IfNotPresent
      resources:
        limits:
          cpu: 100m
          memory: 256Mi
        requests:
          cpu: 50m
          memory: 256Mi
      service:
        type: ClusterIP
        port: 80
        targetPort: {{ .Values.ports.prefect_worker_api | default 8081 }}
      securityContext:
        runAsUser: 1003600000
        fsGroup: 1003600000

    deploy:
      replicas: 1
      image:
        stream: prefect-deploy
        tag: dev
        pullPolicy: IfNotPresent
      resources:
        requests:
          cpu: 50m
          memory: 256Mi
        limits:
          cpu: 100m
          memory: 256Mi
      securityContext:
        runAsUser: 1003600000
        fsGroup: 1003600000

env:
  NODE_ENV: "development"
  NODE_OPTIONS: "--max-old-space-size=4096"
  FRONTEND_PORT: "{{ .Values.ports.frontend }}"
  API_PORT: "{{ .Values.ports.api }}"
  API_HOST: "{{ .Values.urls.api_host }}"
  ZARR_STORE_PATH: "/data/output_1000.zarr"
