name: Build and Push Images to OpenShift Registry

on:
  push:
    branches:
      - main

env:
  OPENSHIFT_SERVER: https://api.gold.devops.gov.bc.ca:6443
  IMAGE_REPOSITORY: conservation-tool
  IMAGE_REGISTRY: image-registry.apps.gold.devops.gov.bc.ca

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.changes.outputs.frontend }}
      workflows: ${{ steps.changes.outputs.workflows }}
      helm: ${{ steps.changes.outputs.helm }}
      force_build: ${{ steps.force-build.outputs.force_build }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for force build
        id: force-build
        run: |
          if [ "${{ vars.FORCE_BUILD }}" = "true" ]; then
            echo "force_build=true" >> $GITHUB_OUTPUT
            echo "ðŸš€ FORCE_BUILD is enabled - will build all components"
          else
            echo "force_build=false" >> $GITHUB_OUTPUT
            echo "FORCE_BUILD is disabled - checking for changes"
          fi

      - name: Debug what changed
        run: |
          echo "Current commit: ${{ github.sha }}"
          echo "Previous commit: ${{ github.event.before }}"
          echo "Force build: ${{ steps.force-build.outputs.force_build }}"
          echo "Frontend changed: ${{ steps.changes.outputs.frontend }}"
          echo "Changed files:"
          git diff --name-only ${{ github.event.before }} ${{ github.sha }}

      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            frontend:
              - 'frontend/**'
            workflows:
              - 'workflows/**'
            helm:
              - 'helm/**'

  build-push:
    runs-on: ubuntu-latest
    needs: [changes]
    if: ${{ needs.changes.outputs.force_build == 'true' || needs.changes.outputs.frontend == 'true' || needs.changes.outputs.workflows == 'true' }}
    environment: dev
    env:
      TOOLS_NAMESPACE: ${{ secrets.TOOLS_NAMESPACE }}
      TOOLS_SA_TOKEN: ${{ secrets.TOOLS_SA_TOKEN }}                  
      IMAGE_TAG: dev
      IMAGE_TAG_LATEST: latest
      GIT_SHA: ${{ github.sha }}
      NODE_ENV: ${{ vars.NODE_ENV }}
      NODE_OPTIONS: ${{ vars.NODE_OPTIONS }}
      PREFECT_API_URL: ${{ vars.PREFECT_API_URL }}
      ZARR_STORE_PATH: ${{ vars.ZARR_STORE_PATH }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install OpenShift CLI
        uses: redhat-actions/openshift-tools-installer@v1
        with:
          oc: "4.16"

      - name: Log in to OpenShift
        run: |
          for i in 1 2 3; do
            echo "Attempt $i: Logging into OpenShift..."
            if oc login --token=$TOOLS_SA_TOKEN --server=$OPENSHIFT_SERVER; then
              echo "Login succeeded"
              break
            elif [ "$i" -lt 3 ]; then
              echo "Login failed. Retrying in 15 seconds..."
              sleep 15
            else
              echo "Login failed after 3 attempts."
              exit 1
            fi
          done
          oc project $OPENSHIFT_NAMESPACE

      - name: Log in to OpenShift internal registry
        run: |
          oc whoami -t | docker login $IMAGE_REGISTRY -u unused --password-stdin

      - name: Build and push frontend image
        working-directory: frontend
        run: |
          # Check required env vars
          required_vars=(NODE_ENV NODE_OPTIONS PREFECT_API_URL ZARR_STORE_PATH)
          for var in "${required_vars[@]}"; do
            if [ -z "${!var}" ]; then
              echo "Error: Environment variable $var is not set."
              exit 1
            fi
          done

          BASE_IMAGE="${IMAGE_REGISTRY}/${TOOLS_NAMESPACE}/frontend"
          docker build \
            --build-arg VITE_NODE_ENV="${NODE_ENV}" \
            --build-arg VITE_NODE_OPTIONS="${NODE_OPTIONS}" \
            --build-arg VITE_PREFECT_API_URL="${PREFECT_API_URL}" \
            --build-arg VITE_ZARR_STORE_PATH="${ZARR_STORE_PATH}" \
            -t ${BASE_IMAGE}:${IMAGE_TAG} \
            -t ${BASE_IMAGE}:${IMAGE_TAG_LATEST} \
            -t ${BASE_IMAGE}:${GIT_SHA} \
            -f ./Dockerfile .

          docker push ${BASE_IMAGE}:${IMAGE_TAG}
          docker push ${BASE_IMAGE}:${IMAGE_TAG_LATEST}
          docker push ${BASE_IMAGE}:${GIT_SHA}

      - name: Build and push Prefect worker image
        working-directory: workflows
        if: needs.changes.outputs.workflows == 'true'
        run: |
          BASE_IMAGE="${IMAGE_REGISTRY}/${TOOLS_NAMESPACE}/prefect-worker"
          docker build -t ${BASE_IMAGE}:${IMAGE_TAG} -t ${BASE_IMAGE}:${IMAGE_TAG_LATEST} -t ${BASE_IMAGE}:${GIT_SHA} -f ./Dockerfile.worker .
          docker push ${BASE_IMAGE}:${IMAGE_TAG}
          docker push ${BASE_IMAGE}:${IMAGE_TAG_LATEST}
          docker push ${BASE_IMAGE}:${GIT_SHA}

      - name: Build and push Prefect deploy image
        working-directory: workflows
        if: needs.changes.outputs.workflows == 'true'
        run: |
          BASE_IMAGE="${IMAGE_REGISTRY}/${TOOLS_NAMESPACE}/prefect-deploy"
          docker build -t ${BASE_IMAGE}:${IMAGE_TAG} -t ${BASE_IMAGE}:${IMAGE_TAG_LATEST} -t ${BASE_IMAGE}:${GIT_SHA} -f ./Dockerfile.deploy .
          docker push ${BASE_IMAGE}:${IMAGE_TAG}
          docker push ${BASE_IMAGE}:${IMAGE_TAG_LATEST}
          docker push ${BASE_IMAGE}:${GIT_SHA}

  install-helm:
    runs-on: ubuntu-latest
    needs: [build-push]
    if: ${{ always() }}
    environment: dev
    env:
      OPENSHIFT_NAMESPACE: ${{ secrets.OPENSHIFT_NAMESPACE }}
      SA_TOKEN: ${{ secrets.SA_TOKEN }}
      VALUES: values-dev.yaml
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug - Check required env variables
        run: |
          echo "Checking required environment variables..."
          echo "OPENSHIFT_NAMESPACE is set to: ${OPENSHIFT_NAMESPACE}"
          echo "VALUES file is: ${VALUES}"
          echo "SA_TOKEN is ${SA_TOKEN:+[SET]}"
          echo "OPENSHIFT_SERVER is ${OPENSHIFT_SERVER:+[SET]}"

      - name: Install Helm
        uses: azure/setup-helm@v3

      - name: Build Helm dependencies
        working-directory: helm/conservation-tool
        run: |
          echo "Adding required Helm repos..."
          helm repo add prefecthq https://prefecthq.github.io/prefect-helm
          helm repo update

          echo "Building Helm dependencies..."
          helm dependency build

      - name: Install OpenShift CLI
        uses: redhat-actions/openshift-tools-installer@v1
        with:
          oc: "4.16"

      - name: Log in to OpenShift
        run: |
          for i in 1 2 3; do
            echo "Attempt $i: Logging into OpenShift..."
            if oc login --token=$SA_TOKEN --server=$OPENSHIFT_SERVER; then
              echo "Login succeeded"
              break
            elif [ "$i" -lt 3 ]; then
              echo "Login failed. Retrying in 15 seconds..."
              sleep 15
            else
              echo "Login failed after 3 attempts."
              exit 1
            fi
          done
          oc project $OPENSHIFT_NAMESPACE

      - name: Deploy via Helm
        working-directory: helm/conservation-tool
        run: |
          echo "Starting Helm deployment..."
          helm upgrade --install conservation-tool . \
            --values values.yaml \
            --values ${VALUES} \
            --namespace ${OPENSHIFT_NAMESPACE} \
            --wait \
            --timeout=10m \
            --atomic

      - name: Scale up frontend and worker
        run: |
          oc scale deployment conservation-tool-frontend --replicas=1
          oc scale deployment conservation-tool-prefect-worker --replicas=1

