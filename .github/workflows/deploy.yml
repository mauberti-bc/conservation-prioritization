name: Reusable Deployment Workflow

on:
  workflow_call:
    inputs:
      source_tag:
        required: true
        type: string
      target_tag:
        required: true
        type: string
      environment:
        required: true
        type: string

env:
  IMAGE_REGISTRY: image-registry.openshift-image-registry.svc:5000
  IMAGE_REPOSITORY: conservation-tool
  OPENSHIFT_SERVER: https://api.gold.devops.gov.bc.ca:6443

jobs:
  promote-and-deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    env:
      OPENSHIFT_NAMESPACE: ${{ secrets.OPENSHIFT_NAMESPACE }}
      TOOLS_NAMESPACE: ${{ secrets.TOOLS_NAMESPACE }}
      OC_TOKEN: ${{ secrets.OPENSHIFT_TOKEN }}
      SOURCE_TAG: ${{ inputs.source_tag }}
      TARGET_TAG: ${{ inputs.target_tag }}

    steps:
      - name: Install OpenShift CLI
        uses: redhat-actions/openshift-tools-installer@v1
        with:
          oc: "4.16"

      - name: Log in to OpenShift
        run: |
          oc login --token=$OC_TOKEN --server=$OPENSHIFT_SERVER
          oc project $OPENSHIFT_NAMESPACE

      - name: Log in to OpenShift internal registry
        run: oc registry login

      - name: Mirror and retag images
        run: |
          for COMPONENT in frontend prefect-server prefect-worker prefect-deploy; do
            SRC="${IMAGE_REGISTRY}/${TOOLS_NAMESPACE}/${IMAGE_REPOSITORY}-$COMPONENT:${SOURCE_TAG}"
            DST="${IMAGE_REGISTRY}/${TOOLS_NAMESPACE}/${IMAGE_REPOSITORY}-$COMPONENT:${TARGET_TAG}"
            echo "Promoting $SRC â†’ $DST"
            oc image mirror "$SRC" "$DST"
          done

      - name: Deploy via Helm
        run: |
          helm upgrade --install conservation-tool ./helm/conservation-tool \
            --namespace $OPENSHIFT_NAMESPACE \
            --set frontend.image.repository=${IMAGE_REGISTRY}/${TOOLS_NAMESPACE}/${IMAGE_REPOSITORY}-frontend \
            --set frontend.image.tag=$TARGET_TAG \
            --set prefectServer.image.repository=${IMAGE_REGISTRY}/${TOOLS_NAMESPACE}/${IMAGE_REPOSITORY}-prefect-server \
            --set prefectServer.image.tag=$TARGET_TAG \
            --set prefectWorker.image.repository=${IMAGE_REGISTRY}/${TOOLS_NAMESPACE}/${IMAGE_REPOSITORY}-prefect-worker \
            --set prefectWorker.image.tag=$TARGET_TAG \
            --set prefectDeploy.image.repository=${IMAGE_REGISTRY}/${TOOLS_NAMESPACE}/${IMAGE_REPOSITORY}-prefect-deploy \
            --set prefectDeploy.image.tag=$TARGET_TAG \
            --wait

      - name: Roll Deployments to refresh image pull
        run: |
          echo "Restarting Deployments in namespace: $OPENSHIFT_NAMESPACE"
          oc rollout restart deployment -n $OPENSHIFT_NAMESPACE --all || true

      - name: Roll StatefulSets to refresh image pull (if any)
        run: |
          echo "Restarting StatefulSets in namespace: $OPENSHIFT_NAMESPACE"
          for sts in $(oc get sts -n $OPENSHIFT_NAMESPACE -o name); do
            oc patch "$sts" -n $OPENSHIFT_NAMESPACE -p '{"spec":{"template":{"metadata":{"annotations":{"restarted-at":"'$(date +%s)'"}}}}}'
          done
