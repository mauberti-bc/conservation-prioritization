# Dockerfile.worker
# Base image with Python and GDAL
FROM ghcr.io/osgeo/gdal:ubuntu-small-3.10.0

# Copy uv package manager
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/

RUN mkdir -p /home/app \
    && mkdir -p /tmp/.prefect \
    && mkdir -p /tmp/.config/matplotlib \
    && chmod -R 777 /home/app /tmp/.prefect /tmp/.config/matplotlib

WORKDIR /home/app

# Set Python path to find src package (current directory is workflows root)
ENV PYTHONPATH="/home/app:${PYTHONPATH}"

# Install build deps needed to compile geospatial wheels on arm64 + py312
# - python3-dev provides Python.h
# - python3-venv ensures venv tooling exists
# - pkg-config helps builds locate libs
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
      build-essential \
      curl \
      pkg-config \
      python3 \
      python3-dev \
      python3-venv \
    && rm -rf /var/lib/apt/lists/*

# Copy Python project files first for layer caching
COPY pyproject.toml uv.lock ./

# Install dependencies only (no project yet)
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --locked --no-install-project

# Copy source code (now the project exists)
COPY . ./

# Install the project into the venv (and any editable/build steps)
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --locked

# Add virtualenv to PATH (should be last)
ENV PATH="/home/app/.venv/bin:$PATH"

# (Optional) sanity check
RUN python - <<'EOF'
import rioxarray
import xarray as xr
print("âœ“ imports ok")
EOF
