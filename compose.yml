services:
  frontend:
    image: ${DOCKER_PROJECT_NAME}-frontend-${DOCKER_NAMESPACE}-img
    container_name: ${DOCKER_PROJECT_NAME}-frontend-${DOCKER_NAMESPACE}-container
    build:
      context: ./frontend/
      dockerfile: Dockerfile
    stdin_open: true
    ports:
      - ${FRONTEND_PORT}:${FRONTEND_PORT}
    environment:
      - NODE_ENV=${NODE_ENV}
      - NODE_OPTIONS=${FRONTEND_NODE_OPTIONS}
      - PORT=${FRONTEND_PORT}
      - VITE_PORT=${FRONTEND_PORT}
      - VITE_PREFECT_API_URL=${PREFECT_API_URL}
      - VITE_APP_API_PORT=${API_PORT}
      - VITE_APP_API_HOST=${API_HOST}
      - VITE_ZARR_STORE_PATH=${ZARR_STORE_PATH}
    volumes:
      - ./frontend:/opt/app-root/src
      - /opt/app-root/src/node_modules
      - ./workflows/data:/opt/app-root/src/public/data
    networks:
      - conservation-network

  prefect_server:
    build:
      context: ./workflows
      dockerfile: Dockerfile.server
    image: ${DOCKER_PROJECT_NAME}-prefect-server-${DOCKER_NAMESPACE}-img
    container_name: ${DOCKER_PROJECT_NAME}-prefect-server-${DOCKER_NAMESPACE}-container
    stdin_open: true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4200/api/health"]
      interval: 15s
      timeout: 15s
      retries: 10
    ports:
      - 4200:4200
      - 8080:8080
    environment:
      - PREFECT_SERVER_API_HOST=0.0.0.0
      - PREFECT_UI_API_URL=http://localhost:4200/api
      - ZARR_STORE_PATH=${ZARR_STORE_PATH}
    networks:
      - conservation-network

  prefect_worker:
    build:
      context: ./workflows
      dockerfile: Dockerfile.worker
    stdin_open: true
    image: ${DOCKER_PROJECT_NAME}-prefect-worker-${DOCKER_NAMESPACE}-img
    container_name: ${DOCKER_PROJECT_NAME}-prefect-worker-${DOCKER_NAMESPACE}-container
    command: ["prefect", "worker", "start", "-p", "local"]
    volumes:
      - ./workflows/data:/data
    depends_on:
      prefect_deploy:
        condition: service_completed_successfully
    environment:
      - PREFECT_API_URL=http://prefect_server:4200/api
      - ZARR_STORE_PATH=${ZARR_STORE_PATH}
    networks:
      - conservation-network

  prefect_deploy:
    build:
      context: ./workflows
      dockerfile: Dockerfile.deploy
    image: ${DOCKER_PROJECT_NAME}-prefect-deploy-${DOCKER_NAMESPACE}-img
    container_name: ${DOCKER_PROJECT_NAME}-prefect-deploy-${DOCKER_NAMESPACE}-container
    depends_on:
      prefect_server:
        condition: service_healthy
    command: ["bash", "src/setup.sh"]
    environment:
      - PREFECT_API_URL=http://prefect_server:4200/api
      - ZARR_STORE_PATH=${ZARR_STORE_PATH}
    networks:
      - conservation-network

networks:
  conservation-network:
    driver: bridge